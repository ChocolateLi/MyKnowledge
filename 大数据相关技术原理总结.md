# 大数据相关技术原理总结

## 一、Hadoop

### 1、HDFS 的读流程和写流程

#### HDFS 读数据流程

![HDFS 读数据流程](https://github.com/ChocolateLi/MyKnowledgeRepository/blob/main/picture/HDFS%E8%AF%BB%E6%B5%81%E7%A8%8B.png)

1. 客户端通过Distributed FileSystem 向 NameNode请求下载文件，NameNode查询元数据，找到文件所在DataNode地址，返回给客户端
2. 客户端挑选最近的一台DataNode 服务器，请求读取数据
3. DataNode开始传输数据给客户端（从磁盘里面读取数据输入流，以Package为单位做校验）
4. 客户端以Package为单位接收，现在本地缓存，然后写入目标文件

#### HDFS 写数据流程

![HDFS 写数据流程](https://github.com/ChocolateLi/MyKnowledgeRepository/blob/main/picture/HDFS%E5%86%99%E6%B5%81%E7%A8%8B.png)

1. 客户端通过Distributed FileSystem 向 NameNode 请求上传文件，NameNode 先检查文件是否存在，父目录是否存在
2. NameNode返回是否可以上传文件
3. 客户端请求第一块Block上传到哪几个DataNode服务器上
4. NameNode返回DataNode节点。假设返回3个，分别是dn1、dn2、dn3
5. 客户端通过FSOutputStream模块向dn1请求上传数据，dn1收到请求会继续调用dn2、然后dn2调用dn3，这样通信管道建立完成
6. dn1、dn2、dn3逐级应答客户端
7. 客户端开始往dn1开始上传第一个Block，以Package为单位，dn1收到一个Package就会传给dn2,dn2传给dn3；dn1每传一个Package会放入应答队列等待应答
8. 当一个Block请求上传完成之后，客户端再次请求NameNode上传下一个Block的服务器（重复3-8步骤）



### 2、Shuffle及优化

#### Shuffle过程

![mapreduce的shuffle过程](https://github.com/ChocolateLi/MyKnowledgeRepository/blob/main/picture/mapreduce%E7%9A%84shuffle%E8%BF%87%E7%A8%8B.png)

Map方法之后，Reduce方法之前的数据处理过程称之为Shuffle

过程：

1. MapTask收集我们map()方法输出的kv对，放到环形缓冲区中
2. 当环形缓冲区达到80%时，不断溢出文件到本地磁盘，可能会溢出多个文件
3. 多个溢出文件会被合并成大的溢出文件
4. 在溢出过程及合并过程中，都要调用Partitioned进行分区和针对key进行排序
5. ReduceTask根据自己的分区号，去各个MapTask机器上取相应的分区数据
6. ReduceTask会取到同一个分区但是来自不同MapTask的结果文件，ReduceTask再次将这些文件进行合（归并排序）
7. 合并成大文件后，shuffle过程结束，开始进入ReduceTask运算逻辑



#### 优化

##### Map阶段

1. 增大环形缓冲区的大小（比如从100M增大到200M）
2. 增大环形缓冲区的溢写比例（比如由80%增大到90%）
3. 减少溢写文件merge次数
4. 不影响业务的情况下，采用Combiner提前合并，减少I/O

##### Reduce阶段

1. 合理设置Map和Reduce数
2. 设置Map和Reduce共存：即Map达到运行到一定时间的时候，Reduce也开始运行，减少Reduce等待时间
3. 规避使用Reduce。Reduce在连接数据集时会产生大量的网络消耗
4. 增加Reduce去拿Map中数据的并行数
5. 增加Reduce端存储数据内存的大小

##### I/O传输

采用数据压缩的方式，减少网络I/O的时间



### 3、Yarn

#### Yarn组成

Yarn由ResourceManaget、NodeManager、ApplicationMaster、Container组成

ResourceManager：负责处理客户端请求，进行资源的分配和调度

NodeManger：处理ResourceManger的命令，管理相应节点上的资源

ApplicationMaster：为应用程序申请资源并且分配任务

Container：资源的抽象，里面封装了CPU、内存等资源

#### Yarn工作机制

#### Yarn作业提交流程

#### Yarn调度器








# JVM、JUC原理总结

## JVM

### 1、JVM内存分为哪几个区？每个区的作用

![JVM内存区域](D:\github\MyKnowledgeRepository\picture\java内存区域.png)



线程私有的：程序计数器、虚拟机栈、本地方法栈

线程共享的：堆、方法区



**程序计数器**

记录正在执行的虚拟机字节码指令的地址



**虚拟机栈**

每个java方法在执行的同时会创建一个栈帧，用于存储局部变量表、操作数栈、常量池引用等信息。

从方法调用直至完成的过程，对应着一个栈帧在java虚拟机栈中入栈和出栈的过程

![**虚拟机栈**](D:\github\MyKnowledgeRepository\picture\java虚拟机栈.png)



**本地方法栈**

本地方法栈和虚拟机栈类似，它们之间的区别是本地方法栈为本地方法服务

本地方法一般是用其他语言(C、C++)编写的，编译为基于本地硬件和操作系统的程序。



**堆**

所有对象都在这里分配内存，是垃圾收集的主要区域

java堆可以细分为：新生代和老年代

新生代还可以细分为：Eden、from survivor、to survivor



**方法区**

用于存放已被加载的类信息、常量、静态变量等信息



虚拟机把它当永久代来进行垃圾回收，但很难确定永久代的大小，因为它受很多因素的影响，每次Full GC后，永久代的大小都会改变，经常抛出OutOfMemoryError的异常。为了更容易管理方法区，从JDK1.8开始，移除永久代，并把方法区移至元空间，它位于本地内存中，而不是虚拟机内存中



![jdk1.8内存区域](D:\github\MyKnowledgeRepository\picture\JDK1.8内存区域.png)



### 2、Java类加载的过程

类加载的过程包括：加载、验证、准备、解析、初始化等5个过程

1. 加载

   加载过程完成三件事情：

   - 通过类的全限定名称获取该类的二进制流
   - 将该二进制流中的静态存储结构转化为方法区运行时的数据结构
   - 在内存中生成该类的class对象，作为该类的数据访问入口

2. 验证

   确保class文件的字节流中的信息不会危害到虚拟机

3. 准备

   准备阶段是为类变量分配内存并且设置初始值，使用的是方法区的内存。

   实例变量不会在这阶段分配内存，它会在对象实例化时随着对象一起分配在堆中。

   可以发现，实例化不是类加载的过程，类加载发生在所有实例化之前，并且类加载只进行一次，实例化可以进行多次。

4. 解析

   该阶段主要完成符号引用到直接引用的转换动作

5. 初始化

   初始化阶段才是真正执行类中定义的java代码。初始化阶段是虚拟机执行类构造器方法的过程。



### 3、垃圾收集算法

1. **标记-清除**

   该算法分为“标记”和“清除”阶段，首先标记出所有不需要清除的对象，在标记完成后同一回收掉没有被标记的对象。

   不足：

   标记和清除的过程效率不高

   会产生大量不连续内存碎片

   ![标记清除](D:\github\MyKnowledgeRepository\picture\标记清除算法.png)

   

2. **标记-整理**

   把所有存活的对象移到一端，然后清理掉端边界的以外的所有内存

   优点：不会产生内存碎片

   缺点：需要移动大量对象，处理效率比较低

   ![标记整理](D:\github\MyKnowledgeRepository\picture\标记整理算法.png)

   

3. **标记-复制**

   将内存分为大小相同的两块，每次使用其中一块。当一块内存使用完之后，将存活的对象复制到另一块，然后把使用过的内存空间清理掉

   主要不足是只使用了内存的另一半

   ![标记复制](D:\github\MyKnowledgeRepository\picture\标记复制算法.png)

   

   

4. **分代收集**

   它根据对象存活周期将内存分为几块，不同块采用适当的收集算法

   一般将堆分为新生代和老年代

   - 新生代：使用标记-复制算法
   - 老年代：使用标记-清除或标记-整理

   

### 4、如何判断对象是否存活

**1、应用计数算法**

为对象添加一个引用计数器，每当有一个地方引用它，计数器加1；当引用失效，计数器减1。计数为0时，对象可回收。

优点：简单、高效

缺点：很难解决对象之间相互引用的问题

**2、可达性分析算法**

以GC Roots为起始点进行搜索，可到达的对象都是存活的，不可达到的对象可被回收的

![可达性分析算法](D:\github\MyKnowledgeRepository\picture\可达性分析算法.png)





### 5、什么是类加载器，累加器有哪些？

通过类的全限定名获取类的二进制字节流的代码块叫做类加载器



## JUC


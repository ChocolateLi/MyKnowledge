# 数据仓库

## 数据仓库设计

**金科玉律**

1、在每个代理键为主键的表中，尤其维度表，必定有自然键作为可选键。绝对不允许仅仅存在一个代理键而没有自然键的现象

2、代理键绝不可以对用户可见，通常用于join，而不用where的搜索条件。此外代理键的命名规则要非常明确，比如xxxxx_SK



## NULL

**隐患**

1. 数学运算：任何数字与null值做数学运算都为null
2. where子句：搞清楚null含义，小心"<>"以及“全选”
3. join：null与null join没有结果
4. 聚合函数：若null设为0，AVG、MIN、MAX、COUNT均受影响
5. 子查询：当存在Null时，使用not in需要特别注意



## 规范化

规范化的目的：减少冗余，同一含义的数据只存一份



每个非键值属性必须依赖于键（1NF），依赖整个键而不是键的一部分（2NF），并且不依赖于其他非键值属性（3NF）



规范化之前：

1、列出实体：名词

2、勾勒关系：动词

3、尽量消除多对多关系

4、列出所有属性



### 第一范式

原子性，列不可再分，没有重复的列，也没有重复的行



### 第二范式

非主键属性依赖于整个键，而不是其中一部分



1、首先满足第一范式

2、如果非主键属性只依赖于主键的一部分，则需要移除创建新表



### 第三范式

非主键属性只依赖于键，不能依赖于其他非主键属性



1、首先满足第二范式

2、如果非主键属性还依赖于其他非主属性，则需要移除创建新表



## 命名规范

1、Table Space

表空间分类 _ 数据分类 _ 数据用途 _ 8K01



2、Buffer Pool

BP_ 用途 _ 8k01



3、索引

IDX _ col name _ 索引类型



4、key

主键：PK_ col name

外键：FK _ col name _ 类型



5、约束

CK _ col name _ 类型



6、job

job_ 



7、Sequence

SEQ_ 



8、存储过程

SP _ 



## 元数据

元数据是用于描述数据的信息



## 项目

做项目前的10个基本问题：

1. 规模。大中小
2. 成熟程度。低中高
3. 文档是否完备。完整、不完整、缺失
4. 是否需要特殊技能的人员。是、否
5. 是否需要与第三方合作。是、否
6. 架构的复杂性。简单、中等、复杂
7. 是否有成熟的管理模式。是、否
8. 变化频率。低中高
9. 系统关键程度。低中高
10. 是否有产品支持。是否



## 数据仓库架构图

### 整体架构图

![整体架构](D:\github\MyKnowledgeRepository\picture\整体架构.png)

### 技术架构图

![技术架构图](D:\github\MyKnowledgeRepository\picture\技术架构图.png)

### 应用架构

![应用架构图](D:\github\MyKnowledgeRepository\picture\应用架构.png)

### 数据架构

![数据架构图](D:\github\MyKnowledgeRepository\picture\数据架构.png)



**DW层**

数据仓库是一个面向主题的、集成的、相对稳定的、反映历史变化的数据集合，用于支持管理决策。

数据仓库就是多维模型模式下的数据集市的聚合



DW（数据仓库） & DM（数据集市）

数据集市是为了特定的应用目的或应用范围，而从数据仓库独立出来的一部分数据，也可以称为部门数据或主题数据

![DW & DM](D:\github\MyKnowledgeRepository\picture\DW和DM对比.png)



## 数据仓库建模

数据仓库建模的过程是先规范化，再逆规范化

### 逻辑模型

**日期设计**

![逻辑模型-日期](D:\github\MyKnowledgeRepository\img\picture\逻辑模型-日期.png)



**拉链表**

拉链表反应历史数据的

拉链表的实现是通过时间戳来实现的 

![拉链表](D:\github\MyKnowledgeRepository\img\picture\拉链表.png)



### 数据建模流程

1.业务调研：收集分析业务需求

2.业务域划分：分析业务和需求，将数据进行维度划分

3.明确统计指标：明确原子指标和派生指标

4.数据规范定义：构建明确的原子指标、派生指标和维度指标

5.数仓模型设计：DIM、DWD、DWS

6.代码开发。



## 实时数仓

### 传统数仓解决不了什么问题？

简单总结，就是时效性。比如用户画像需要实时特征提取、活动实时的看板、广告投放效果实时OLAP分析以及机器学习在线训练等



### 离线数仓 VS 实时数仓

![](D:\github\MyKnowledgeRepository\img\DW_img\离线数仓VS实时数仓.png)



### 数仓分层

| 层级 | 英文名                 | 中文名     | 定义                                             |
| ---- | ---------------------- | ---------- | ------------------------------------------------ |
| APP  | application            | 应用数据层 | 提供一些差异的数据服务，实现报表、自助提数等     |
| DM   | data market            | 数据集市层 | 加工多维度冗余的大宽表                           |
| DWS  | DW summary             | 汇总数据层 | 沉淀派生指标、同一计算口径、避免重复计算，可复用 |
| DWB  | DW base                | 基础数据层 | 面向主题、轻度汇总                               |
| DWD  | DW detail              | 明细数据层 | 数据的清洗、整合、分类等                         |
| DIM  | dimension              | 维度层     | 根据业务构建相应的维表                           |
| ODS  | operational data store | 操作数据层 | 直接获得数据                                     |



### 实时数仓

**ODS层**

实时数仓ODS层，本质上是把生产系统的原始数据导入MQ，原则上不做任何清洗操作

命名：ods _ {数据源存储名} _ {库名} _ {表名}



**DWD层**

dwd层采用**维度建模**理论，针对业务内容梳理业务实体的维表信息和事实表信息，设计dwd明细宽表模型。

根据设计好的模型对ods层的数据进行**数据清洗**，定义和整合。整合主要包括**多流的join**和维度扩充。

建设能表达该**业务主题**下的**多维明细宽表流**。

命名：dwd _ {主题名} _ {业务描述}

建模：梳理业务过程，设计能涵盖该**业务过程**的逻辑模型



**DWS层**

主要在dwd层的基础上针对**业务实体**跨业务主题建设**汇总指标**，设计汇总指标模型

命名：dws _ {业务实体名} _ {指标描述} _ {指标时间粒度}

建模：梳理该**实体**涉及的所有业务主题。比如直播，一场直播数据会涉及到流量主题/交易主题/电商主题等多个业务主题，需要一套dws模型涵盖实体各业务主题下的指标。



技术路线：ODS(kafka) -> DWD/DWS(kafka) -> Dim(kv、mysql、hbase) -> ADS(clickhouse、ES、Redis)



### Lambda VS Kappa 架构存在的问题

**Lambda架构**

- 同时维护实时离线两套计算模型
- 用户同时维护两套代码
- 两套数据链路，造成数据不一致

**Kappa架构**

- 消息队列回溯能力不及离线
- 消息队列无法直接提供数据查询和分享能力
- 全链路依赖消息队列，数据时序性可能造成结果错误

![](D:\github\MyKnowledgeRepository\img\DW_img\Lambda VS Kappa.png)



### Flink SQL

Flink SQL(流式SQL)是一套API，Flink会将SQL解析、优化并最终翻译成标准的Flink作业，本质上跟直接用DataStream API直接写Flink作业没有根本区别。

Flink SQL 最终会翻译成一个个的物理执行算子，上下游连接的算子之间会有数据的传输。



**Streaming SQL过程**

Streaming SQL会把Stream转化成一个动态的表，然后在这个动态的表上执行Streaming SQL，结果任然是一个动态表，而且这个动态表还可以转换为Stream

![](D:\github\MyKnowledgeRepository\img\DW_img\Streaming SQL.png)



### Hudi

Hudi是新一代的“流式数据湖平台”，为数据湖提供表的功能。





## 数仓面试题

### 数据分层

数据分层的主要原因是在管理数据的时候，对数据有一个清晰的掌控。

每个企业根据自己的业务分成不同的层次，但最基础的分层思想是分为三层：数据运营层(ODS层)、数据仓库层(DW)、数据应用层(ADS)

京东数仓分层：BDM -> FDM -> GDM -> ADM

**ODS层**

保持数据原貌不做任何修改，起到备份数据的作用。后续数据仓库加工的来源

**DW层**

DW数据分层为DWD、DWB、DWS

DWD:data warehouse details数据细节层，是业务层与数据仓库的隔离层，主要是对ODS数据层做一些数据清洗和规范化操作。

DWB:data warehouse base数据基础层，存储的是客观数据，一般作为中间层，里面有很多维度的数据层。

DWS:data warehouse service数据服务层，基于DWB的数据做聚合，用于后续的业务应用

**ADS层**

该层主要是提供数据产品和数据分析使用的数据。报表数据一般存在这里。



# 数仓建模

1.为什么要数仓建模？

数据爆发式的增长，如何有序、有结构地分类组织和存储是我们面临的一个挑战。



2.表和数据模型有什么区别？

数据模型就是数据组织和存储方法，强调的是从业务、数据存储和使用角度合理存储数据。

表就是数据存储和使用。比如给你画一个圆形，那么它代表是圆，但如果你赋予它一个意义，比如篮球，那么它代表就是篮球。

表只是物理载体，业务赋予其意义。



3.ER建模和维度建模

ER建模要符合三范式建模理论，数据冗余比较少。

维度建模最大的区别就是他不会被冗余的数据所约束住，基于事实和维度进行建模。



4.OneData体系

指标定义体系、模型设计方法体系、配套工具



5.大数据建设方法论的核心？（或者如何快速上手工作？）

从业务架构设计到模型设计，从数据研发到数据服务，做到数据可管理、可追溯、可规避重复建设。

我们未来的发展方向是以数据服务为核心，比如数据质量和数据治理提升我们数据服务准确度，数据产品提升我们数据可视化服务的体感。



6.数仓体系架构

![](D:\github\MyKnowledgeRepository\img\DW_img\数仓体系架构.png)



7.事实表分几种？

根据分层划分了明细层事实表（最原始粒度的明细数据）和汇总层事实表。明细事实表又分为三种



8.主题域如何划分？

是根据业务过程去分的。用户、渠道、营销、流量、交易、财务、商品



9.原子指标与派生指标

派生指标唯一归属于一个原子指标，继承原子指标的主题域，与修饰词的主题域无关。

派生指标 = 原子指标 + 时间周期修饰词 + 其他修饰词



